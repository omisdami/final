<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="/static/css/loader.css" />

    <title>Targeted Section Editing - Kinectrics</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>

    <!-- Floating Background Shapes -->
    <div class="floating-shape shape1"></div>
    <div class="floating-shape shape2"></div>
    <div class="floating-shape shape3"></div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center gap-2 sora-font-nav" href="/">
                <span class="material-symbols-outlined">description</span>
                AI Document Generator by Kinectrics
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto sora-font-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/generate-report">Get Started</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/report-templates">Report Templates</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/targeted-edit">Targeted Editing</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- END Navigation Bar -->

    <!-- Hero Section -->
    <div class="container-fluid text-center mt-5 fade-section sora-font" style="padding-top:100px;">
        <h1 class="fw-bold" style="color:#0066ff;">Targeted Section Editing</h1>
        <p class="text-muted roboto-font">
            Upload an example document and selectively modify specific sections using AI.
        </p>
    </div>

    <!-- Main Content -->
    <div class="container-fluid my-5 fade-section">
        <div class="row g-4">

            <!-- Left: Main Form -->
            <div class="col-md-8">
                <div class="p-4 bg-white rounded shadow roboto-font">

                    <form id="editForm">
                        <!-- Example Document Upload -->
                        <h5 class="d-flex align-items-center gap-2 mb-3">
                            <span class="material-symbols-outlined">upload_file</span>
                            Example Document (base to modify)
                        </h5>
                        <div class="mb-4">
                            <input type="file" id="exampleFile" accept=".pdf,.docx" class="form-control" required>
                            <small class="text-muted">Upload the document you want to modify</small>
                        </div>

                        <!-- Reference Documents Upload -->
                        <h5 class="d-flex align-items-center gap-2 mb-3">
                            <span class="material-symbols-outlined">folder_open</span>
                            Reference Documents (content source)
                        </h5>
                        <div class="mb-4">
                            <input type="file" id="referenceFiles" accept=".pdf,.docx" multiple class="form-control"
                                required>
                            <small class="text-muted">Upload one or more reference documents for content
                                extraction</small>
                        </div>

                        <!-- Sections to Change -->
                        <h5 class="d-flex align-items-center gap-2 mb-3">
                            <span class="material-symbols-outlined">edit_note</span>
                            Sections to Change
                        </h5>
                        <div id="sectionChanges" class="mb-3">
                            <div class="section-change card mb-3 shadow-sm">
                                <div class="card-body position-relative">
                                    <span class="badge bg-primary position-absolute top-0 end-0 m-2">Section 1</span>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Section Name</label>
                                        <input type="text" class="section-name form-control"
                                            placeholder="e.g., Executive Summary" required>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label fw-semibold">Instructions</label>
                                        <textarea class="user-direction form-control" rows="3"
                                            placeholder="Describe how this section should change..."
                                            required></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-success mb-3" onclick="addSectionChange()">
                            âž• Add Another Section
                        </button>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                ðŸš€ Generate Edited Document
                            </button>
                        </div>
                    </form>

                    <!-- Result Section -->
                    <div id="result" class="mt-4"></div>

                </div>
            </div>

            <!-- Right: Instructions Panel -->
            <div class="col-md-4 fade-section">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="d-flex align-items-center gap-2">
                            <span class="material-symbols-outlined">info</span> How It Works
                        </h5>
                        <ol class="mt-3">
                            <li>Upload an <strong>example document</strong> that will serve as the base template.</li>
                            <li>Upload one or more <strong>reference documents</strong> containing the source content.
                            </li>
                            <li>Specify which sections you want to modify and provide clear instructions for each.</li>
                            <li>Click "Generate Edited Document" and let AI selectively update only the specified
                                sections.</li>
                            <li>Download your modified document while preserving the rest of the original content.</li>
                        </ol>
                        <div class="alert alert-info mt-3">
                            <strong>Tip:</strong> Be specific in your section instructions. The AI will use content from
                            the reference documents to update only the sections you specify.
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Loader Overlay -->
    <div id="global-loader" class="hidden">
        <div class="loader-backdrop"></div>
        <div class="loader-panel">
            <div class="spinner" aria-hidden="true"></div>
            <p>Processing your documentâ€¦ This may take 1-2 minutes.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-5 text-muted fade-section">
        <hr />
        <p>Â© 2025 Kinectrics Report Generator | Powered by AI</p>
    </footer>

    <!-- JavaScript -->
    <script>
        // Reveal sections on scroll
        const fadeSections = document.querySelectorAll('.fade-section');
        const revealOnScroll = () => {
            const trigger = window.innerHeight * 0.85;
            fadeSections.forEach(section => {
                const top = section.getBoundingClientRect().top;
                if (top < trigger) section.classList.add('visible');
            });
        }
        window.addEventListener('scroll', revealOnScroll);
        revealOnScroll(); // initial call to show sections immediately

        let sectionCount = 1;

        function addSectionChange() {
            sectionCount++;
            const container = document.getElementById('sectionChanges');
            const div = document.createElement('div');
            div.className = 'section-change card mb-3 shadow-sm';
            div.innerHTML = `
        <div class="card-body position-relative">
          <span class="badge bg-primary position-absolute top-0 end-0 m-2">Section ${sectionCount}</span>
          <div class="mb-3">
            <label class="form-label fw-semibold">Section Name</label>
            <input type="text" class="section-name form-control" placeholder="e.g., Executive Summary" required>
          </div>
          <div class="mb-0">
            <label class="form-label fw-semibold">Instructions</label>
            <textarea class="user-direction form-control" rows="3" placeholder="Describe how this section should change..." required></textarea>
          </div>
        </div>
      `;
            container.appendChild(div);
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            const exampleFile = document.getElementById('exampleFile').files[0];
            const refFiles = document.getElementById('referenceFiles').files;

            if (!exampleFile) {
                alert('Please select an example document');
                return;
            }
            if (refFiles.length === 0) {
                alert('Please select at least one reference document');
                return;
            }

            formData.append('example_file', exampleFile);
            for (let file of refFiles) {
                formData.append('reference_files', file);
            }

            const changes = [];
            document.querySelectorAll('.section-change').forEach(div => {
                const name = div.querySelector('.section-name').value.trim();
                const direction = div.querySelector('.user-direction').value.trim();
                if (name && direction) {
                    changes.push({ section_name: name, user_direction: direction });
                }
            });

            if (changes.length === 0) {
                alert('Please specify at least one section to change');
                return;
            }

            formData.append('section_changes', JSON.stringify(changes));

            // Show loader
            const loader = document.getElementById('global-loader');
            loader.classList.remove('hidden');

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('/documents/targeted-edit/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // Hide loader
                loader.classList.add('hidden');

                if (response.ok) {
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
            <h5 class="alert-heading d-flex align-items-center gap-2">
              <span class="material-symbols-outlined">check_circle</span>
              Editing Complete!
            </h5>
            <hr>
            <p class="mb-3">
              <strong>Download:</strong> 
              <a href="/${result.output_file}" download class="btn btn-sm btn-outline-primary ms-2">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">download</span>
                ${result.output_file.split('/').pop()}
              </a>
            </p>
            <div class="row text-center mt-3">
              <div class="col-md-4">
                <div class="border rounded p-3 bg-white">
                  <div class="fs-2 fw-bold text-primary">${result.total_sections}</div>
                  <div class="text-muted small">Total Sections</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="border rounded p-3 bg-white">
                  <div class="fs-2 fw-bold text-success">${result.sections_modified}</div>
                  <div class="text-muted small">Modified</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="border rounded p-3 bg-white">
                  <div class="fs-2 fw-bold text-secondary">${result.sections_unchanged}</div>
                  <div class="text-muted small">Unchanged</div>
                </div>
              </div>
            </div>
          `;
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `
            <h5 class="alert-heading d-flex align-items-center gap-2">
              <span class="material-symbols-outlined">error</span>
              Error
            </h5>
            <p class="mb-0">${result.detail || 'An error occurred during processing'}</p>
          `;
                }
            } catch (error) {
                // Hide loader
                loader.classList.add('hidden');

                resultDiv.style.display = 'block';
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `
          <h5 class="alert-heading d-flex align-items-center gap-2">
            <span class="material-symbols-outlined">error</span>
            Error
          </h5>
          <p class="mb-0">Failed to process request: ${error.message}</p>
        `;
            }
        });
    </script>

</body>

</html>